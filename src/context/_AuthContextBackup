import axios from "axios";
import React, { createContext } from "react";

import * as SecureStore from "expo-secure-store";

import { BASE_URL } from "../config";
import * as Device from "expo-device";
import { useState } from "react";
import { useEffect } from "react";
import { Linking } from "react-native";

export const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
  //LOGGED IN USER ALL DATA
  const [validToken, setValidToken] = useState(false);

  const [userInfo, setUserInfo] = useState({});
  const [userNFCDevices, setUserNFCDevices] = useState({});
  const [userActiveYeetDevice, setUserActiveYeetDevice] = useState({});
  const [notificationCount, setNotificationCount] = useState();

  //CACHED DATA
  const [userName, setUserName] = useState();
  const [tempUserName, setTempUserName] = useState();
  const [userBio, setUserBio] = useState();
  const [tempUserBio, setTempUserBio] = useState();
  const [userCoverPhoto, setUserCoverPhoto] = useState();
  const [tempCoverPhoto, setTempCoverPhoto] = useState();
  const [userProfilePhoto, setUserProfilePhoto] = useState();
  const [tempProfilePhoto, setTempProfilePhoto] = useState();

  const [nfcDeviceLoading, setNfcDeviceLoading] = useState(false);
  const [userInfoLoading, setUserInfoLoading] = useState(false);

  //PASSWORD MATCHING
  const [passwordMatched, setPasswordMatched] = useState(false);

  //USER BLOCKED CONNECTIONS
  const [userBlockedConnections, setUserBlockedConnections] = useState({});

  //UPDATE PROFILE STATES
  const [updateSuccessModalVisible, setUpdateSuccessModalVisible] =
    useState(false);
  const [updateErrorModalVisible, setUpdateErrorModalVisible] = useState(false);

  //LOGGED IN USER LINKS
  const [userLinks, setUserLinks] = useState({});
  const [userLinksLoading, setUserLinksLoading] = useState(false);
  //AUTH TOKEN
  const [userToken, setUserToken] = useState();
  //GET ALL LINKS FROM DATABASE
  const [allLinks, setAllLinks] = useState({});
  const [addLinkLoading, setAddLinkLoading] = useState(false);
  const [showAddLinkMessage, setShowAddLinkMessage] = useState(false);

  const [userDirectLink, setUserDirectLink] = useState();
  const [userDirectLinkID, setUserDirectLinkID] = useState();
  //GET ALL CONNECTIONS OF USER
  const [userConnections, setUserConnections] = useState({});
  const [userConnectionsLoading, setUserConnectionsLoading] = useState({});
  //SHOW CONNECTION OF USER
  const [userConnectionData, setUserConnectionData] = useState({});
  //SHOW CONNECTION LINKS
  const [userConnectionLinks, setUserConnectionLinks] = useState({});
  const [userConnectionStatus, setUserConnectionStatus] = useState();
  const [userBlockStatus, setUserBlockStatus] = useState();
  const [userPrivateStatus, setUserPrivateStatus] = useState();

  //REGISTRATION STATE IF NEXT STEP IS VALID
  const [valid, setValid] = useState(false);

  //FORGOT PASSWORD STATE IF VALID EMAIL
  const [validEmail, setValidEmail] = useState(false);
  const [validCode, setValidCode] = useState(false);
  const [validPassword, setValidPassword] = useState(false);

  const [registered, setRegistered] = useState(false);

  //SPINNER LOADING STATE
  const [isLoading, setIsLoading] = useState(false);
  //SPLASHSCREEN LOADING STATE
  const [splashLoading, setSplashLoading] = useState(true);
  //REFRESHING PAGES
  const [refreshing, setRefreshing] = useState(false);

  //SHOWING MODAL STATE
  const [showModal, setShowModal] = useState(false);
  //SHOWING MODAL WITH BUTTONs
  const [showButtonModal, setShowButtonModal] = useState(false);
  //SHOW MODAL WITH TEXTINPUT
  const [showInputModal, setShowInputModal] = useState(false);
  //SHOW SUCCESS MODAL
  const [showSuccessModal, setShowSuccessModal] = useState(false);

  //ERROR MESSAGE DISPLAYING
  const [errorMessage, setErrorMessage] = useState("");
  //SUCCESS MESSAGE DISPLAYING
  const [successMessage, setSuccessMessage] = useState("");

  //MODAL HEADER ERROR OR SUCCESS
  const [modalHeader, setModalHeader] = useState("");
  //MODAL MESSAGE ERROR OR SUCCESS
  const [modalMessage, setModalMessage] = useState("");

  const [publicProfileInfo, setPublicProfileInfo] = useState({});
  const [publicProfileLinks, setPublicProfileLinks] = useState({});
  const [publicProfileDirectLink, setPublicProfileDirectLink] = useState();
  const [publicConnectionStatus, setPublicConnectionStatus] = useState();
  const [userNotFound, setUserNotFound] = useState(false);
  const [publicLoading, setPublicLoading] = useState(false);

  const [userNotifications, setUserNotifications] = useState({});
  const [userNotificationsLoading, setUserNotificationsLoading] =
    useState(false);
  const [notificationPushToken, setNotificationPushToken] = useState();

  //INSIGHTS
  const [userProfileTaps, setUserProfileTaps] = useState();
  const [userLinksInsights, setUserLinksInsights] = useState({});
  const [totalUserLinkTaps, setTotalUserLinkTaps] = useState();
  const [totalUserConnections, setTotalUserConnections] = useState();
  const [totalProfileViews, setTotalProfileViews] = useState();

  const [userTheme, setUserTheme] = useState({});

  //MODAL STATES
  const [welcomeModalVisible, setWelcomeModalVisible] = useState(false);
  const [loginModalVisible, setLoginModalVisible] = useState(false);
  const [successPasswordModalVisible, setSuccessPasswordModalVisible] =
    useState(false);
  const [errorPasswordModalVisible, setErrorPasswordModalVisible] =
    useState(false);
  const [lockedAccountModalVisible, setLockedAccountModalVisible] =
    useState(false);
  const [forgotEmailModalVisible, setForgotEmailModalVisible] = useState(false);
  const [resetCodeModalVisible, setResetCodeModalVisible] = useState(false);
  const [newPasswordModalVisible, setNewPasswordModalVisible] = useState(false);

  const [registrationModalVisible, setRegistrationModalVisible] =
    useState(false);
  const [confirmEmailModalVisible, setConfirmEmailModalVisible] =
    useState(false);
  const [inputNameModalVisible, setInputNameModalVisible] = useState(false);
  const [mobileNumberModalVisible, setMobileNumberModalVisible] =
    useState(false);

  const [addLinksModalVisible, setAddLinksModalVisible] = useState(false);
  const [editLinkMessageModalVisible, setEditLinkMessageModalVisible] =
    useState(false);
  const [homeModalVisible, setHomeModalVisible] = useState(false);
  const [viewConnectionModalVisible, setViewConnectionModalVisible] =
    useState(false);
  const [connectionsScreenModalVisible, setConnectionsScreenModalVisible] =
    useState(false);

  const [updateAccountModalVisible, setUpdateAccountModalVisible] =
    useState(false);
  const [updatePasswordErrorModalVisible, setUpdatePasswordErrorModalVisible] =
    useState(false);
  const [
    updatePasswordSuccessModalVisible,
    setUpdatePasswordSuccessModalVisible,
  ] = useState(false);
  const [invalidPasswordModalVisible, setInvalidPasswordModalVisible] =
    useState(false);
  const [deactivateModalVisible, setDeactivateModalVisible] = useState(false);
  const [reactivateModalVisible, setReactivateModalVisible] = useState(false);
  const [deleteAccountModalVisible, setDeleteAccountModalVisible] =
    useState(false);
  const [finalConfirmationModalVisible, setFinalConfirmationModalVisible] =
    useState(false);

  //LOADING STATES
  const [loginLoading, setLoginLoading] = useState(false);
  const [forgotPasswordEmailLoading, setForgotPasswordEmailLoading] =
    useState(false);

  const [publicProfileLoading, setPublicProfileLoading] = useState(false);
  const [insightsLoading, setInsightsLoading] = useState(false);
  const [manageAccountLoading, setManageAccountLoading] = useState(false);

  //REGISTRATION STEP 1
  

  const checkConfirmationCode = async (code, email) => {
    setIsLoading(true);
    axios
      .post(`${BASE_URL}api/checkConfirmationCode`, {
        code: code,
        email: email,
      })
      .then((response) => {
        if (response.data.code == 200) {
          setValid(true);
        } else if (response.data.code == 401) {
          setValid(false);
          setConfirmEmailModalVisible(true);
          setModalHeader("Error");
          setModalMessage(response.data.error);
        }
        console.log(response.data);
        setIsLoading(false);
      })
      .catch((e) => {
        setConfirmEmailModalVisible(true);
        setModalHeader("Error");
        setModalMessage(e.response.data.errors);
        console.log(e.response.data);
        setIsLoading(false);
      });
    // console.log(code)
  };

  const register = async (
    fileUri,
    fileName,
    fileType,
    email,
    fullName,
    password,
    mobileNumber
  ) => {
    setUserInfoLoading(true);
    if (!fileUri) {
      await axios
        .post(`${BASE_URL}api/register`, {
          fullName: fullName,
          email: email,
          password: password,
          deviceName: Device.modelName,
          mobileNumber: mobileNumber,
        })
        .then((response) => {
          setRegistered(true);

          let userInfo = response.data;
          setUserInfo(userInfo.user);
          setUserToken(userInfo.token);
          setUserTheme(userInfo.userTheme);

          SecureStore.setItemAsync("userUUID", userInfo.user.usr_uuid);
          SecureStore.setItemAsync("userToken", userInfo.token);

          setUserInfoLoading(false);
          console.log(userInfo);
        })
        .catch((e) => {
          console.log(e.response.data);
          setIsLoading(false);
          setRegistered(false);
        });
    } else {
      let formData = new FormData();

      formData.append("profileImage", {
        uri: fileUri,
        name: fileName,
        type: fileType,
      });
      console.log(fileUri + fileName + fileType);
      formData.append("fullName", fullName);
      formData.append("email", email);
      formData.append("password", password);
      formData.append("deviceName", Device.modelName);
      formData.append("mobileNumber", mobileNumber);

      await axios({
        method: "POST",
        url: `${BASE_URL}api/register`,
        data: formData,
        // body: formData,
        headers: {
          Accept: "application/json",
          "Content-Type": "multipart/form-data",
        },
      })
        .then((response) => {
          setRegistered(true);

          let userInfo = response.data;
          setUserInfo(userInfo.user);
          setUserToken(userInfo.token);
          setUserTheme(userInfo.userTheme);

          SecureStore.setItemAsync("userUUID", userInfo.user.usr_uuid);
          SecureStore.setItemAsync("userToken", userInfo.token);

          setUserInfoLoading(false);
          console.log(userInfo);
        })
        .catch((error) => {
          console.log(error);
          setUserInfoLoading(false);
          setRegistered(false);
        });
    }
  };

  const updateProfile = async (
    profilePhotoURI,
    profilePhotoName,
    profilePhotoType,
    coverPhotoURI,
    coverPhotoName,
    coverPhotoType,
    userName,
    userBio
  ) => {
    // setUserInfoLoading(true);
    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    let formData = new FormData();

    if (profilePhotoURI) {
      formData.append("profilePhoto", {
        uri: profilePhotoURI,
        name: profilePhotoName,
        type: profilePhotoType,
      });
    }
    if (coverPhotoURI) {
      formData.append("coverPhoto", {
        uri: coverPhotoURI,
        name: coverPhotoName,
        type: coverPhotoType,
      });
    }

    formData.append("userName", userName);
    formData.append("userBio", userBio);
    formData.append("userUUID", userUUID);
    await axios({
      method: "POST",
      url: `${BASE_URL}api/updateProfile`,
      data: formData,
      headers: {
        Accept: "application/json",
        Authorization: `Bearer ${userToken}`,
        "Content-Type": "multipart/form-data",
      },
    })
      .then((response) => {
        console.log(response.data);
        if (response.data.profilePhotoError) {
          setUpdateErrorModalVisible(true);
          setModalHeader("Profile Photo Upload Error");
          setModalMessage(response.data.profilePhotoError);
        } else if (response.data.coverPhotoError) {
          setUpdateErrorModalVisible(true);
          setModalHeader("Cover Photo Upload Error");
          setModalMessage(response.data.coverPhotoError);
        } else {
          let userInfo = response.data.user;
          setTempProfilePhoto(null);
          setTempCoverPhoto(null);
          setUserInfo(userInfo);
          console.log(userInfo.usr_name);

          setUserName(userInfo.usr_name);
          setUserBio(userInfo.usr_bio);
          setUserCoverPhoto(userInfo.usr_cover_photo_storage);
          setUserProfilePhoto(userInfo.usr_profile_photo_storage);

          SecureStore.setItemAsync("userName", userInfo.usr_name);
          SecureStore.setItemAsync("userBio", userInfo.usr_bio);
          SecureStore.setItemAsync(
            "userCoverPhoto",
            userInfo.usr_cover_photo_storage
          );
          SecureStore.setItemAsync(
            "userProfilePhoto",
            userInfo.usr_profile_photo_storage
          );
        }

        // setUserInfoLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        // setUserInfoLoading(false);
      });
  };

  const updateEmail = async (newEmail, password) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    axios
      .patch(
        `${BASE_URL}api/updateUserEmail/${userUUID}`,
        {
          newEmail: newEmail,
          password: password,
        },
        {
          headers: {
            Accept: "application/json",
            Authorization: `Bearer ${userToken}`,
          },
        }
      )
      .then((response) => {
        // console.log(response.errors.newEmail)
        if (response.data.passwordError) {
          console.log(response.data.passwordError);
          setShowModal(true);
          setErrorMessage(response.data.passwordError);
        } else if (response.data.emailError) {
          console.log(response.data.emailError);
          setShowModal(true);
          setErrorMessage(response.data.emailError);
        } else {
          let userInfo = response.data.user;
          console.log(userInfo);
          setUserInfo(userInfo);
          setShowModal(true);
          setSuccessMessage(response.data.success);
        }
        // console.log(response)
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response.data.errors.newEmail);
        setShowModal(true);
        setErrorMessage(error.response.data.errors.newEmail);
        setIsLoading(false);
      });
  };

  const updatePassword = async (oldPassword, newPassword) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    axios
      .patch(
        `${BASE_URL}api/updateUserPassword/${userUUID}`,
        {
          oldPassword: oldPassword,
          newPassword: newPassword,
        },
        {
          headers: {
            Accept: "application/json",
            Authorization: `Bearer ${userToken}`,
          },
        }
      )
      .then((response) => {
        console.log(response.data);
        if (response.data.passwordError) {
          console.log(response.data.passwordError);
          setUpdatePasswordErrorModalVisible(true);
          setErrorMessage(response.data.passwordError);
        } else {
          let userInfo = response.data.user;
          console.log(response.data);
          setUserInfo(userInfo);
          setUpdatePasswordSuccessModalVisible(true);
          setSuccessMessage(response.data.success);
        }
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const updateMobileNumber = async (mobileNumber) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    axios
      .patch(
        `${BASE_URL}api/updateMobileNumber/${userUUID}`,
        {
          mobileNumber: mobileNumber,
        },
        {
          headers: {
            Accept: "application/json",
            Authorization: `Bearer ${userToken}`,
          },
        }
      )
      .then((response) => {
        // console.log(response.errors.newEmail)
        // if (response.data.passwordError) {
        //   console.log(response.data.passwordError);
        //   setShowModal(true);
        //   setErrorMessage(response.data.passwordError);
        // } else if (response.data.emailError) {
        //   console.log(response.data.emailError);
        //   setShowModal(true);
        //   setErrorMessage(response.data.emailError);
        // } else {
        let userInfo = response.data.user;
        console.log(userInfo);
        setUserInfo(userInfo);
        setUpdateAccountModalVisible(true);
        setModalHeader("Success");
        setModalMessage(response.data.success);
        // setSuccessMessage(response.data.success);
        // }
        // console.log(response)
        setIsLoading(false);
      })
      .catch((error) => {
        // console.log(error.response.data.errors.newEmail);
        // setShowModal(true);
        // setErrorMessage(error.response.data.errors.newEmail);
        setUpdateAccountModalVisible(true);
        setModalHeader("Error");
        setModalMessage(error.response.data);
        setIsLoading(false);
      });
  };

  const resetPassword = async (email) => {
    setIsLoading(true);

    axios
      .post(
        `${BASE_URL}api/resetPassword`,
        {
          email: email,
        },
        {
          headers: {
            Accept: "application/json",
          },
        }
      )
      .then((response) => {
        console.log(response.data);
        if (response.data.emailError) {
          setValidEmail(false);
          setForgotEmailModalVisible(true);
          setModalHeader("Error");
          setModalMessage(response.data.emailError);
        } else if (response.data.coolDown) {
          setForgotEmailModalVisible(true);
          setModalHeader("Password Reset Code");
          setModalMessage(response.data.coolDown);
        } else {
          setValidEmail(true);
        }
        setIsLoading(false);
      })
      .catch((error) => {
        console.log("Error: " + error);
        setForgotEmailModalVisible(true);
        setModalHeader("Error");
        setModalMessage(error.response.data);
        setValidEmail(false);
        setIsLoading(false);
      });
  };

  const checkPasswordResetCode = async (code, email) => {
    setIsLoading(true);

    axios
      .post(`${BASE_URL}api/checkPasswordResetCode`, {
        email: email,
        code: code,
      })
      .then((response) => {
        if (response.data.code == 200) {
          setValidCode(true);
        } else if (response.data.code == 401) {
          setValidCode(false);
          setResetCodeModalVisible(true);
          setModalHeader("Error");
          setModalMessage(response.data.error);
        }
        console.log(response.data);
        setIsLoading(false);
      })
      .catch((error) => {
        setResetCodeModalVisible(true);
        setModalHeader("Error");
        setModalMessage(error.response.data);
        console.log(error.response.data);
        setValidCode(false);
        setIsLoading(false);
      });
  };

  const newPassword = async (password, email) => {
    setIsLoading(true);

    axios
      .post(`${BASE_URL}api/newPassword`, {
        newPassword: password,
        email: email,
      })
      .then((response) => {
        if (response.data.emailError) {
          setErrorPasswordModalVisible(true);
          setModalHeader("Error");
          setModalMessage(response.data.emailError);
          setValidPassword(false);
        } else if (response.data.passwordError) {
          setErrorPasswordModalVisible(true);
          setModalHeader("Error");
          setModalMessage(response.data.passwordError);
          setValidPassword(false);
        } else if (response.data.success) {
          setSuccessPasswordModalVisible(true);
          setModalHeader("Success");
          setModalMessage(response.data.success);
          setValidPassword(true);
        }
        console.log(response.data);
        setIsLoading(false);
      })
      .catch((e) => {
        setNewPasswordModalVisible(true);
        setModalHeader("Error");
        setModalMessage(e.response.data.errors);
        setValidPassword(false);
        console.log(e.response.data);
        setIsLoading(false);
      });
  };

  const deactivateAccount = async (password) => {
    setManageAccountLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/deactivateAccount/${userUUID}`,
        {
          password: password,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        if (response.data.passwordError) {
          setInvalidPasswordModalVisible(true);
          setModalHeader("Invalid Password");
          setModalMessage(response.data.passwordError);
        } else if (response.data.success) {
          setDeactivateModalVisible(true);
          setModalHeader("Account Deactivated");
          setModalMessage(response.data.success);
        }
        console.log(response.data);
        setManageAccountLoading(false);
      })
      .catch((error) => {
        console.log(error);
        setManageAccountLoading(false);
      });
  };

  const deleteAccount = async () => {
    setManageAccountLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/deleteAccount/${userUUID}`,
        {},
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        setDeleteAccountModalVisible(true);
        setModalHeader("Account Deleted");
        setModalMessage(response.data.success);

        console.log(response.data);
        setManageAccountLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setManageAccountLoading(false);
      });
  };

  const toggleNotifications = async (status) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    axios
      .patch(
        `${BASE_URL}api/toggleNotifications/${userUUID}/${status}`,
        {},
        {
          headers: {
            Accept: "application/json",
            Authorization: `Bearer ${userToken}`,
          },
        }
      )
      .then((response) => {
        let userInfo = response.data.userInfo;
        setUserInfo(userInfo);
        console.log(userInfo);
        setIsLoading(false);
      })
      .catch((e) => {
        console.log(e.response.data);
        setIsLoading(false);
      });
  };

  const toggleAccountPrivacy = async (status) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    axios
      .patch(
        `${BASE_URL}api/toggleAccountPrivacy/${userUUID}/${status}`,
        {},
        {
          headers: {
            Accept: "application/json",
            Authorization: `Bearer ${userToken}`,
          },
        }
      )
      .then((response) => {
        let userInfo = response.data.userInfo;
        setUserInfo(userInfo);
        console.log(userInfo);
        setIsLoading(false);
      })
      .catch((e) => {
        console.log(e.response.data);
        setIsLoading(false);
      });
  };

  const checkPassword = async (password) => {
    setManageAccountLoading(true);
    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .post(
        `${BASE_URL}api/checkPassword`,
        {
          password: password,
          userUUID: userUUID,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        if (response.data.passwordError) {
          setPasswordMatched(false);
          setInvalidPasswordModalVisible(true);
          setModalHeader("Password Error");
          setModalMessage("You have entered an invalid password.");
        } else if (response.data.success) {
          console.log(response.data.success);
          setPasswordMatched(true);
        }
        console.log(passwordMatched);
        setManageAccountLoading(false);
      })
      .catch((e) => {
        console.log(e);
        setManageAccountLoading(false);
      });
  };

  const login = async (email, password) => {
    // setUserLinksLoading(true);
    setUserInfoLoading(true);
    axios
      .post(`${BASE_URL}api/login`, {
        email: email,
        password: password,
        deviceName: Device.modelName,
      })
      .then((response) => {
        let responseData = response.data.data;
        if (responseData.emailError) {
          setLoginModalVisible(true);
          setModalHeader("Error");
          setModalMessage(responseData.emailError);
          console.log(responseData);
        } else if (responseData.passwordError) {
          setLoginModalVisible(true);
          setModalHeader("Error");
          setModalMessage(responseData.passwordError);
          // console.log(attemptCount);
          console.log(response.data);
        } else if (responseData.finalWarning) {
          setLoginModalVisible(true);
          setModalHeader("Error");
          setModalMessage(responseData.finalWarning);
          // console.log(attemptCount);
          console.log(response.data);
        } else if (responseData.blockedAccount) {
          setLockedAccountModalVisible(true);
          setModalHeader("Account Locked");
          setModalMessage(responseData.blockedAccount);
          console.log(responseData);
        } else {
          let userInfo = responseData.userData;
          if (userInfo.user.usr_is_active == -1) {
            setReactivateModalVisible(true);
            setModalHeader("Welcome Back");
            setModalMessage("Welcome back! We are happy to see you again!");
          }
          setUserInfo(userInfo.user);
          setUserNFCDevices(userInfo.nfcDevices);
          setUserToken(userInfo.token);
          setUserActiveYeetDevice(userInfo.user.nfc_device);
          setUserDirectLink(userInfo.user.usr_direct_link_active);
          setUserDirectLinkID(userInfo.user.uln_id);
          setUserTheme(userInfo.user.thm_id);
          setUserLinks(userInfo.userLinks);
          console.log(userInfo);

          setUserName(userInfo.user.usr_name);
          setUserBio(userInfo.user.usr_bio);
          setUserProfilePhoto(userInfo.user.usr_profile_photo_storage);
          setUserCoverPhoto(userInfo.user.usr_cover_photo_storage)

          if (userInfo.user.nfc_device) {
            SecureStore.setItemAsync(
              "userActiveYeetDevice",
              userInfo.user.nfc_device
            );
          }
          if (userInfo.nfcDevices) {
            SecureStore.setItemAsync(
              "userYeetDevices",
              JSON.stringify(userInfo.nfcDevices)
            );
          }
          SecureStore.setItemAsync("userName", userInfo.user.usr_name);
          SecureStore.setItemAsync("userBio", userInfo.user.usr_bio);
          SecureStore.setItemAsync(
            "userCoverPhoto",
            userInfo.user.usr_cover_photo_storage
          );
          SecureStore.setItemAsync(
            "userProfilePhoto",
            userInfo.user.usr_profile_photo_storage
          );
          SecureStore.setItemAsync("userUUID", userInfo.user.usr_uuid);
          SecureStore.setItemAsync("userToken", userInfo.token);
        }
        setUserInfoLoading(false);
      })
      .catch((error) => {
        setUserInfoLoading(false);
        console.warn(error);
        console.log(error.response.data.status);
        console.log(error.response);
      });
  };

  const logout = () => {
    setIsLoading(true);
    axios
      .post(
        `${BASE_URL}api/logout`,
        {},
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((res) => {
        console.log(res.data);

        SecureStore.deleteItemAsync("userInfo");
        SecureStore.deleteItemAsync("userUUID");
        SecureStore.deleteItemAsync("userToken");
        SecureStore.deleteItemAsync("userName");
        SecureStore.deleteItemAsync("userEmail");
        SecureStore.deleteItemAsync("userBio");
        SecureStore.deleteItemAsync("userMobile");
        SecureStore.deleteItemAsync("userCoverPhoto");
        SecureStore.deleteItemAsync("userProfilePhoto");
        SecureStore.deleteItemAsync("userLinks");
        SecureStore.deleteItemAsync("cachedUserInfo");
        // AsyncStorage.removeItem("userInfo");
        setUserToken(null);
        setUserLinks({});
        setUserInfo({});
        setUserActiveYeetDevice({});
        setUserNFCDevices({});
        setAllLinks({});
        setUserConnections({});
        setUserConnectionData({});
        setUserConnectionLinks({});
        setIsLoading(false);
        setSplashLoading(false);
      })
      .catch((e) => {
        console.log(e.response.status);
        console.log(e.response.data);
        setIsLoading(false);
      });
  };

  const getUserLinks = async (uuid, token) => {
    setIsLoading(true);
    setUserLinksLoading(true);
    await axios
      .get(`${BASE_URL}api/getUserLinks/${uuid}`, {
        headers: { Authorization: `Bearer ${token}` },
      })
      .then((response) => {
        let userLinks = response.data;
        console.log(userLinks);
        setUserLinks(userLinks);
        setUserLinksLoading(false);
        setIsLoading(false);
        // setRefreshing(false);
        // setSplashLoading(false);
        console.log(userLinks);
      })
      .catch((e) => {
        console.log("Links Error:" + e);
        // setRefreshing(false);
        setIsLoading(false);
        setUserLinksLoading(false);
        setSplashLoading(false);
        setShowModal(true);
        setErrorMessage("Please check your connection!");
      });
  };

  const getUserData = async () => {
    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");
    // setIsLoading(true);
    setUserInfoLoading(true);
    await axios
      .get(`${BASE_URL}api/getUserData/${userUUID}`, {
        headers: {
          Authorization: `Bearer ${userToken}`,
        },
      })
      .then((response) => {
        // console.log(response.data.user);
        let userInfo = response.data.userData;
        setUserInfo(userInfo.user);
        setUserActiveYeetDevice(userInfo.activeNFCDevice);
        setUserNFCDevices(userInfo.nfcDevice);
        setUserToken(userInfo.token);
        setUserDirectLink(userInfo.user.usr_direct_link_active);
        setUserDirectLinkID(userInfo.user.uln_id);
        setUserLinks(userInfo.userLinks);
        setUserTheme(userInfo.userTheme);
        setNotificationCount(userInfo.notificationCount);

        setUserName(userInfo.user.usr_name);
        setUserBio(userInfo.user.usr_bio);
        setUserCoverPhoto(userInfo.user.usr_cover_photo_storage);
        setUserProfilePhoto(userInfo.user.usr_profile_photo_storage);

        SecureStore.setItemAsync("userName", userInfo.user.usr_name);
        SecureStore.setItemAsync("userBio", userInfo.user.usr_bio);
        // SecureStore.setItemAsync("userEmail", userInfo.user.usr_email);
        // SecureStore.setItemAsync("userMobile", userInfo.user.usr_mobile);
        SecureStore.setItemAsync(
          "userCoverPhoto",
          userInfo.user.usr_cover_photo_storage
        );
        SecureStore.setItemAsync(
          "userProfilePhoto",
          userInfo.user.usr_profile_photo_storage
        );
        // console.log(response.data);
        console.log("Logged In as: " + userInfo.user.usr_email);
        console.log(
          "Direct Link Active: " + userInfo.user.usr_direct_link_active
        );
        console.log("Direct Link ID: " + userInfo.user.uln_id);
        // console.log(userInfo.notificationCount);
        console.log(userInfo.userLinks);
        // setRefreshing(false);
        // setSplashLoading(false);
        // setIsLoading(false);
        setUserInfoLoading(false);

        setShowModal(false);
      })
      .catch((error) => {
        if (error.response.status === 401) {
          console.log("Data Error: " + error.response.status);

          setWelcomeModalVisible(true);
          setModalHeader("Login Error");
          setModalMessage(
            "Oops! It seems your current login has expired. Please sign in again to continue."
          );

          clearAll();
        }

        setUserInfoLoading(false);
        setSplashLoading(false);
      });
  };

  const getAllLinks = async () => {
    setIsLoading(true);
    setRefreshing(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .get(`${BASE_URL}api/getAllLinks`, {
        headers: { Authorization: `Bearer ${userToken}` },
      })
      .then((response) => {
        let allLinks = response.data;
        setAllLinks(allLinks);
        // console.log("Links: ", allLinks.socialMedia);
        setRefreshing(false);
        setIsLoading(false);
        // console.log(response.data);
      })
      .catch((error) => {
        console.log(error.response.data);
        setRefreshing(false);
        setIsLoading(false);
      });
  };

  const removeLinkFromUser = async (userLinkID) => {
    // setUserLinksLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .post(
        `${BASE_URL}api/removeLinkFromUser`,
        {
          userUUID: userUUID,
          userLinkID: userLinkID,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        console.log(response.data);

        // getUserLinks(userUUID, userToken);
        // setIsLoading(false);
      })
      .catch((error) => {
        console(error.response);
        setUserLinksLoading(false);
      });
  };

  const addLink = async (userLinkID, userLinkURLHeader, userLinkURL) => {
    setAddLinkLoading(true);
    // setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .post(
        `${BASE_URL}api/addUserLink`,
        {
          userUUID: userUUID,
          userLinkID: userLinkID,
          userLinkURLHeader: userLinkURLHeader,
          userLinkURL: userLinkURL,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        if (response.data.duplicateLink) {
          setAddLinkLoading(false);
          setAddLinksModalVisible(true);
          setModalHeader("Error");
          setModalMessage(response.data.duplicateLink);
        } else {
          let userLinks = response.data;

          console.log(userLinks);
          setUserLinks(userLinks);
          setAddLinksModalVisible(true);
          setModalHeader("Success");
          setModalMessage("Link saved successfully!");
          // getUserLinks(userUUID, userToken);
          // setIsLoading(false);1
          setAddLinkLoading(false);
          console.log(response.data);
        }
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const addCustomLink = async (userLinkID, userLinkName, userLinkURL) => {
    setAddLinkLoading(true);
    // setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .post(
        `${BASE_URL}api/addCustomLink`,
        {
          userUUID: userUUID,
          userLinkID: userLinkID,
          userLinkName: userLinkName,
          userLinkURL: userLinkURL,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        if (response.data.duplicateLink) {
          setAddLinkLoading(false);
          setAddLinksModalVisible(true);
          setModalHeader("Error");
          setModalMessage(response.data.duplicateLink);
        } else {
          let userLinks = response.data;

          console.log(userLinks);
          setUserLinks(userLinks);
          setAddLinksModalVisible(true);
          setModalHeader("Success");
          setModalMessage("Link saved successfully!");
          // getUserLinks(userUUID, userToken);
          // setIsLoading(false);1
          setAddLinkLoading(false);
          console.log(response.data);
        }
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const addYouTubeLink = async (
    userLinkID,
    youtubeLinkName,
    youtubeURL,
    youtubeThumbnailURI
  ) => {
    setAddLinkLoading(true);
    // setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .post(
        `${BASE_URL}api/addYouTubeLink`,
        {
          userUUID: userUUID,
          userLinkID: userLinkID,
          youtubeLinkName: youtubeLinkName,
          youtubeURL: youtubeURL,
          youtubeThumbnailURI: youtubeThumbnailURI,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        if (response.data.duplicateLink) {
          setAddLinkLoading(false);
          setAddLinksModalVisible(true);
          setModalHeader("Error");
          setModalMessage(response.data.duplicateLink);
        } else {
          let userLinks = response.data;

          console.log(userLinks);
          setUserLinks(userLinks);
          setAddLinksModalVisible(true);
          setModalHeader("Success");
          setModalMessage("Link saved successfully!");
          // getUserLinks(userUUID, userToken);
          // setIsLoading(false);1
          setAddLinkLoading(false);
          console.log(response.data);
        }
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const editYouTubeLink = async (
    userLinkIndex,
    youtubeLinkName,
    youtubeURL,
    youtubeThumbnailURI
  ) => {
    // setAddLinkLoading(true);
    // setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .post(
        `${BASE_URL}api/editYouTubeLink`,
        {
          userUUID: userUUID,
          userLinkIndex: userLinkIndex,
          youtubeLinkName: youtubeLinkName,
          youtubeURL: youtubeURL,
          youtubeThumbnailURI: youtubeThumbnailURI,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        if (response.data.duplicateLink) {
          setAddLinkLoading(false);
          setAddLinksModalVisible(true);
          setModalHeader("Error");
          setModalMessage(response.data.duplicateLink);
        } else {
          let userLinks = response.data;

          console.log(userLinks);
          setUserLinks(userLinks);
          setEditLinkMessageModalVisible(true);
          setModalHeader("Success");
          setModalMessage("Link saved successfully!");
          // getUserLinks(userUUID, userToken);
          // setIsLoading(false);1
          // setAddLinkLoading(false);
          console.log(response.data);
        }
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const uploadPaymentPhoto = async (
    userLinkID,
    paymentPhotoURI,
    paymentPhotoFileName,
    paymentPhotoFileType
  ) => {
    setAddLinkLoading(true);
    // setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    let formData = new FormData();
    formData.append("paymentPhoto", {
      uri: paymentPhotoURI,
      name: paymentPhotoFileName,
      type: paymentPhotoFileType,
    });

    formData.append("userUUID", userUUID);
    formData.append("userLinkID", userLinkID);
    await axios({
      method: "POST",
      url: `${BASE_URL}api/uploadPaymentPhoto`,
      data: formData,
      headers: {
        Accept: "application/json",
        Authorization: `Bearer ${userToken}`,
        "Content-Type": "multipart/form-data",
      },
    })
      .then((response) => {
        let userLinks = response.data;
        setUserLinks(userLinks);
        setAddLinksModalVisible(true);
        setModalHeader("Success");
        setModalMessage("Image successfully uploaded.");
        setAddLinkLoading(false);
        console.log(response.data);
      })
      .catch((error) => {
        console.log(error.response);
        setAddLinkLoading(false);
      });
  };

  const uploadFile = async (fileURI, fileName, fileType, fileTitle) => {
    setAddLinkLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    let formData = new FormData();
    formData.append("file", {
      uri: fileURI,
      name: fileName,
      type: fileType,
    });
    formData.append("originalFileName", fileName);
    formData.append("fileTitle", fileTitle);
    formData.append("userUUID", userUUID);

    await axios({
      method: "POST",
      url: `${BASE_URL}api/uploadFile`,
      data: formData,
      headers: {
        Accept: "application/json",
        Authorization: `Bearer ${userToken}`,
        "Content-Type": "multipart/form-data",
      },
    })
      .then((response) => {
        console.log(response.data);
        let userLinks = response.data;
        setUserLinks(userLinks);
        setAddLinksModalVisible(true);
        setModalHeader("Success");
        setModalMessage("File successfully uploaded.");
        setAddLinkLoading(false);
      })
      .catch((error) => {
        console.log(error);
        setAddLinkLoading(false);
      });
  };

  const editFile = async (
    fileURI,
    fileName,
    fileType,
    fileTitle,
    linkIndex
  ) => {
    setUserLinksLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    if (!fileURI) {
      await axios
        .post(
          `${BASE_URL}api/editFile`,
          {
            userUUID: userUUID,
            fileTitle: fileTitle,
            linkIndex: linkIndex,
          },
          {
            headers: { Authorization: `Bearer ${userToken}` },
          }
        )
        .then((response) => {
          console.log(response.data);
          let userLinks = response.data;
          setUserLinks(userLinks);
          setShowSuccessModal(true);
          setModalMessage("File successfully renamed.");
          setUserLinksLoading(false);
        })
        .catch((error) => {
          console.log(error.response.data);
          setUserLinksLoading(false);
        });
    } else {
      let formData = new FormData();
      formData.append("file", {
        uri: fileURI,
        name: fileName,
        type: fileType,
      });
      formData.append("originalFileName", fileName);
      formData.append("fileTitle", fileTitle);
      formData.append("userUUID", userUUID);
      formData.append("linkIndex", linkIndex);

      await axios({
        method: "POST",
        url: `${BASE_URL}api/editFile`,
        data: formData,
        headers: {
          Accept: "application/json",
          Authorization: `Bearer ${userToken}`,
          "Content-Type": "multipart/form-data",
        },
      })
        .then((response) => {
          console.log(response.data);
          let userLinks = response.data;
          setUserLinks(userLinks);
          setShowSuccessModal(true);
          setModalMessage("File successfully uploaded.");
          setUserLinksLoading(false);
        })
        .catch((error) => {
          console.log(error);
          setUserLinksLoading(false);
        });
    }
  };

  const editLink = async (userLinkIndex, userLinkURL) => {
    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/editUserLink/${userUUID}`,
        {
          userUUID: userUUID,
          userLinkIndex: userLinkIndex,
          userLinkURL: userLinkURL,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        if (response.data.duplicateLink) {
          setEditLinkMessageModalVisible(true);
          setModalHeader("Error");
          setModalMessage(response.data.duplicateLink);
        } else {
          let userLinks = response.data.userLinks;
          setUserLinks(userLinks);
          setEditLinkMessageModalVisible(true);
          setModalHeader("Success");
          setModalMessage("Link successfully updated");
        }
        // console.log(response.data);
        // let userLinks = response.data.userLinks;
        // setUserLinks(userLinks);
        // if (userLinksLoading == false) {
        //   setShowModal(true);
        //   setSuccessMessage("Link successfully updated.");
        // }
        // setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
      });
  };

  const editCustomLink = async (userLinkIndex, userLinkName, userLinkURL) => {
    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    // console.log(userLinkIndex)
    await axios
      .patch(
        `${BASE_URL}api/editCustomLink/${userUUID}`,
        {
          userUUID: userUUID,
          userLinkIndex: userLinkIndex,
          userLinkName: userLinkName,
          userLinkURL: userLinkURL,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        console.log(response.data);
        if (response.data.duplicateLink) {
          setEditLinkMessageModalVisible(true);
          setModalHeader("Error");
          setModalMessage(response.data.duplicateLink);
        } else {
          let userLinks = response.data.userLinks;
          setUserLinks(userLinks);
          setShowModal(true);
          setModalHeader("Success");
          setSuccessMessage("Link successfully updated");
        }
        // setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
      });
  };

  const editPaymentPhoto = async (
    userLinkID,
    userLinkIndex,
    paymentPhotoURI,
    paymentPhotoFileName,
    paymentPhotoFileType
  ) => {
    setUserLinksLoading(true);
    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");
    let formData = new FormData();

    formData.append("paymentPhoto", {
      uri: paymentPhotoURI,
      name: paymentPhotoFileName,
      type: paymentPhotoFileType,
    });

    formData.append("userLinkID", userLinkID);
    formData.append("userLinkIndex", userLinkIndex);
    formData.append("userUUID", userUUID);
    await axios({
      method: "POST",
      url: `${BASE_URL}api/editPaymentPhoto`,
      data: formData,
      headers: {
        Accept: "application/json",
        Authorization: `Bearer ${userToken}`,
        "Content-Type": "multipart/form-data",
      },
    })
      .then((response) => {
        console.log(response.data);
        let userLinks = response.data;
        setUserLinks(userLinks);
        setUserLinksLoading(false);
        if (userLinksLoading == false) {
          setShowSuccessModal(true);
          setSuccessMessage("Payment Image successfully updated.");
        }
      })
      .catch((error) => {
        console.log(error.response);
        setUserLinksLoading(false);
      });
  };

  const setDirectLink = async (linkID) => {
    // setUserInfoLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/setDirectLink/${userUUID}`,
        {
          linkID: linkID,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        console.log(response.data);
        setUserDirectLink(1);
        setUserDirectLinkID(linkID);
        // getUserData(userUUID, userToken);
        // getUserLinks(userUUID, userToken);
        // setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const removeDirectLink = async () => {
    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");
    await axios
      .patch(
        `${BASE_URL}api/removeDirectLink/${userUUID}`,
        {},
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        console.log(response.data);
      })
      .catch((error) => {
        console.log(error.response);
      });
  };

  const getUserConnections = async () => {
    setUserConnectionsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .get(`${BASE_URL}api/getConnections/${userUUID}`, {
        headers: { Authorization: `Bearer ${userToken}` },
      })
      .then((response) => {
        setUserNotFound(false);
        let userConnections = response.data.connections;
        setUserConnections(userConnections);
        console.log(userConnections);
        setUserConnectionsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setUserConnectionsLoading(false);
      });
  };

  const searchUserConnections = async (searchKey) => {
    setUserConnectionsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .get(`${BASE_URL}api/searchConnections/${userUUID}/${searchKey}`, {
        headers: { Authorization: `Bearer ${userToken}` },
      })
      .then((response) => {
        let userConnections = response.data.connections;
        setUserConnections(userConnections);
        console.log(userConnections);
        setUserConnectionsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setUserConnectionsLoading(false);
      });
  };

  const showUserConnection = async (connectionUUID) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .get(`${BASE_URL}api/showConnection/${connectionUUID}/${userUUID}`, {
        headers: { Authorization: `Bearer ${userToken}` },
      })
      .then((response) => {
        // let directLinkURL = response.data.directLinkURL;
        // console.log(directLinkURL)
        let blockStatus = response.data.blockStatus;
        setUserBlockStatus(blockStatus);

        let userConnectionData = response.data.connectionData;
        setUserConnectionData(userConnectionData);

        let userConnectionLinks = response.data.connectionLinks;
        setUserConnectionLinks(userConnectionLinks);

        let userConnectionStatus = response.data.userConnectionStatus;
        setUserConnectionStatus(userConnectionStatus);

        // if (userConnectionData.usr_direct_link_active == 1) {
        //   Linking.canOpenURL(directLinkURL).then((supported) => {
        //     if (supported) {
        //       Linking.openURL(directLinkURL);
        //     } else {
        //       setConnectionsScreenModalVisible(true);
        //       setModalHeader("Error");
        //       setModalMessage("This link cannot be opened and may be broken.");
        //     }
        //   });
        // }
        addProfileView(connectionUUID);
        // console.log(userConnectionLinks);
        console.log(response.data);

        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error);
        setIsLoading(false);
      });
  };

  const showProfileFromQR = async (code) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    console.log(userUUID);

    await axios
      .get(`${BASE_URL}api/showProfileFromQR/${code}/${userUUID}`, {})
      .then((response) => {
        console.log(response.data);
        if (response.data.userNotFound) {
          setUserNotFound(true);
        } else {
          let blockStatus = response.data.blockStatus;
          setUserBlockStatus(blockStatus);

          let userConnectionData = response.data.userProfileData;
          setUserConnectionData(userConnectionData);

          let userConnectionLinks = response.data.userProfileLinks;
          setUserConnectionLinks(userConnectionLinks);

          let userConnectionStatus = response.data.connectionStatus;
          setUserConnectionStatus(userConnectionStatus);
          // console.log(userConnectionLinks);
          // console.log(response.data);
        }
        setIsLoading(false);
      })
      .catch((error) => {
        console.log("ERROR: " + error);
        setIsLoading(false);
      });
  };

  const leaveNote = async (note, connectionUUID) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/leaveNote/${connectionUUID}`,
        {
          note: note,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        if (response.data.success) {
          let successMessage = response.data.success;
          console.log(successMessage);

          setConnectionsScreenModalVisible(true);
          setModalHeader("Success");
          setModalMessage(successMessage);
        }
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const reportConnection = async (report, connectionUUID) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/reportConnection/${connectionUUID}`,
        {
          report: report,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        if (response.data.success) {
          let successMessage = response.data.success;
          console.log(successMessage);

          setConnectionsScreenModalVisible(true);
          setModalHeader("Success");
          setModalMessage(successMessage);
        }
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const deleteConnection = async (connectionUUID) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/deleteConnection/`,
        {
          userUUID: userUUID,
          connectionUUID: connectionUUID,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        if (response.data.success) {
          let successMessage = response.data.success;
          let userConnections = response.data.userConnections;
          setUserConnections(userConnections);
          console.log(successMessage);

          setConnectionsScreenModalVisible(true);
          setModalHeader("Success");
          setModalMessage(successMessage);
        }
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const blockConnection = async (connectionConnUUID, connectionUUID) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/blockConnection/${connectionUUID}`,
        {
          userUUID: userUUID,
          connectionConnUUID: connectionConnUUID,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        if (response.data.success) {
          let successMessage = response.data.success;
          let userConnections = response.data.userConnections;
          setUserConnections(userConnections);
          console.log(successMessage);

          setConnectionsScreenModalVisible(true);
          setModalHeader("Success");
          setModalMessage(successMessage);
        }
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const addConnection = async (connectionUUID) => {
    setPublicLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    console.log(userUUID);
    await axios
      .post(
        `${BASE_URL}api/addConnection`,
        {
          userUUID: userUUID,
          connectionUUID: connectionUUID,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        let userConnections = response.data.userConnections;
        let connectionStatus = response.data.connectionStatus;
        setUserConnections(userConnections);
        setUserConnectionStatus(connectionStatus);

        console.log(response.data);
        setViewConnectionModalVisible(true);
        setModalHeader("Success");
        setModalMessage("Connection added successfully!");
        setPublicLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setPublicLoading(false);
      });
  };

  const unblockConnection = async (blockID) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/unblockConnection/${blockID}`,
        {},
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        setShowSuccessModal(true);
        setModalHeader("Success");
        setModalMessage(response.data.success);
        let blockedConnections = response.data.blockedConnections;
        setUserBlockedConnections(blockedConnections);
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const showBlockedConnections = async () => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .get(`${BASE_URL}api/showBlockedConnections/${userUUID}`, {
        headers: { Authorization: `Bearer ${userToken}` },
      })
      .then((response) => {
        let blockedConnections = response.data.blockedConnections;
        setUserBlockedConnections(blockedConnections);
        console.log(blockedConnections);
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const showPublicProfile = async (code) => {
    setPublicProfileLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    console.log(userUUID);

    await axios
      .get(`${BASE_URL}api/publicProfile/${code}/${userUUID}`, {})
      .then((response) => {
        if (response.data.userNotFound) {
          setUserNotFound(true);
        } else {
          let privateStatus = response.data.privateStatus;
          let blockStatus = response.data.blockStatus;
          let publicProfileData = response.data.publicProfileInfo;
          let publicProfileLinks = response.data.publicProfileLinks;
          let publicProfileDirectLink = response.data.publicProfileDirectLink;
          let connectionStatus = response.data.connectionStatus;

          // if (publicProfileData) {
          addProfileTap(response.data.publicProfileInfo.usr_uuid);
          addProfileView(response.data.publicProfileInfo.usr_uuid);

          setUserPrivateStatus(privateStatus);
          setUserBlockStatus(blockStatus);
          setPublicProfileInfo(publicProfileData);
          setPublicProfileLinks(publicProfileLinks);
          setPublicProfileDirectLink(publicProfileDirectLink);
          setPublicConnectionStatus(connectionStatus);
          // console.log("DATA: " + response.data.publicProfileInfo);
        }
        // } else if (publicProfileData == undefined) {
        //   setPublicProfileInfo(null);
        // }
        console.log(response.data);
        // console.log(publicProfileLinks);
        setPublicProfileLoading(false);
      })
      .catch((error) => {
        console.log("ERROR: " + error);
        setPublicProfileLoading(false);
      });
  };

  const getUserTheme = async () => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .get(`${BASE_URL}api/getUserTheme/${userUUID}`, {})
      .then((response) => {
        console.log(response.data);
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const activateYeetDevice = async (code) => {
    setNfcDeviceLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/activateYeetDevice/${code}`,
        {
          userUUID: userUUID,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        let responseData = response.data.data;
        if (responseData.invalidCode) {
          console.log(responseData.invalidCode);

          setShowModal(true);
          setModalHeader("Error");
          setModalMessage(responseData.invalidCode);
        } else if (responseData.ownedDevice) {
          console.log(responseData.ownedDevice);

          setShowModal(true);
          setModalHeader("Error");
          setModalMessage(responseData.ownedDevice);
        } else if (responseData.deviceTaken) {
          console.log(responseData.deviceTaken);

          setShowModal(true);
          setModalHeader("Device Taken");
          setModalMessage(responseData.deviceTaken);
        } else if (responseData.devicesData) {
          console.log(responseData.devicesData);

          setShowModal(true);
          setModalHeader("Success");
          setModalMessage(responseData.devicesData.success);
          setUserActiveYeetDevice(
            responseData.devicesData.yeetDevices.nfc_code
          );
          setUserNFCDevices(responseData.devicesData.yeetDevices);
        }
        setNfcDeviceLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setNfcDeviceLoading(false);
      });
  };

  const getYeetDevices = async () => {
    setNfcDeviceLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .get(`${BASE_URL}api/getYeetDevices/${userUUID}`, {
        headers: { Authorization: `Bearer ${userToken}` },
      })
      .then((response) => {
        console.log(response.data);
        setUserNFCDevices(response.data);
        setNfcDeviceLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setNfcDeviceLoading(false);
      });
  };

  const getActiveYeetDevice = async () => {
    // setNfcDeviceLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .get(`${BASE_URL}api/getActiveYeetDevice/${userUUID}`, {
        headers: { Authorization: `Bearer ${userToken}` },
      })
      .then((response) => {
        let nfcDevice = response.data.nfcDevice;
        console.log("NFC Active Device: " + nfcDevice);

        setUserActiveYeetDevice(nfcDevice);
        SecureStore.setItemAsync("userActiveYeetDevice", nfcDevice);
        // setNfcDeviceLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        // setNfcDeviceLoading(false);
      });
  };

  const displayYeetDevice = async (yeetID, yeetCode) => {
    // setNfcDeviceLoading(true);
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/displayYeetDevice/${yeetCode}`,
        {
          userUUID: userUUID,
          yeetID: yeetID,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        console.log(response.data);
        let activeYeetDevice = response.data.activeYeetDevice;
        setUserActiveYeetDevice(activeYeetDevice);

        setShowSuccessModal(true);
        setModalHeader("Success");
        setModalMessage(response.data.success);
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const disconnectYeetDevice = async (code) => {
    setNfcDeviceLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/disconnectYeetDevice/${code}`,
        {
          userUUID: userUUID,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        console.log(response.data);
        let yeetDevices = response.data.yeetDevices;
        setUserNFCDevices(yeetDevices);

        setShowSuccessModal(true);
        setModalHeader("Success");
        setModalMessage(response.data.success);
        setNfcDeviceLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setNfcDeviceLoading(false);
      });
  };

  const saveNotificationPushToken = async (pushToken) => {
    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .post(
        `${BASE_URL}api/saveNotificationPushToken/`,
        {
          userUUID: userUUID,
          pushToken: pushToken,
          deviceName: Device.modelName,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        console.log(response.data);
      })
      .catch((error) => {
        console.log(error.response);
      });
  };

  const getNotificationPushToken = async () => {
    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");
    let deviceName = Device.modelName;
    await axios
      .get(
        `${BASE_URL}api/saveNotificationPushToken/${userUUID}/${deviceName}`,
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        console.log(response.data);
        let pushToken = response.data.pushToken;
        setNotificationPushToken(pushToken);
      })
      .catch((error) => {
        console.log(error.response);
      });
  };

  const getUserNotifications = async () => {
    setUserNotificationsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .get(`${BASE_URL}api/getNotifications/${userUUID}`, {
        headers: { Authorization: `Bearer ${userToken}` },
      })
      .then((response) => {
        let userNotifications = response.data.userNotifications;
        setUserNotifications(userNotifications);
        setUserNotificationsLoading(false);
        console.log(userNotifications);
      })
      .catch((error) => {
        console.log(error.response);
        setUserNotificationsLoading(false);
      });
  };

  const readNotification = async () => {
    setUserNotificationsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/readNotification/${userUUID}`,
        {},
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        let userNotifications = response.data.userNotifications;
        setUserNotifications(userNotifications);
        // setNotificationCount(0);
        setUserNotificationsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setUserNotificationsLoading(false);
      });
  };

  const openNotification = async (connectionUUID) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .get(`${BASE_URL}api/openNotification/${connectionUUID}/${userUUID}`, {
        headers: { Authorization: `Bearer ${userToken}` },
      })
      .then((response) => {
        let userConnectionData = response.data.connectionData;
        setUserConnectionData(userConnectionData);

        let userConnectionLinks = response.data.connectionLinks;
        setUserConnectionLinks(userConnectionLinks);

        let publicConnectionStatus = response.data.connectionStatus;
        setPublicConnectionStatus(publicConnectionStatus);
        // console.log(userConnectionLinks);
        console.log(response.data);
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error);
        setIsLoading(false);
      });
  };

  const removeNotification = async (notificationID) => {
    // setUserNotificationsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .patch(
        `${BASE_URL}api/removeNotification/${notificationID}/${userUUID}`,
        {},
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        console.log(response.data);
        let userNotifications = response.data.userNotifications;
        setUserNotifications(userNotifications);
        // setUserNotificationsLoading(false);
      })
      .catch((error) => {
        console.log(error);
        // setUserNotificationsLoading(false);
      });
  };

  const downloadVCF = async (
    // profilePhotoURI,
    // profilePhotoName,
    // profilePhotoType,
    firstName,
    lastName,
    mobileNumber,
    email,
    linkNames,
    linkURLSwifi
  ) => {
    setIsLoading(true);

    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");
    // let formData = new FormData();

    // formData.append("profilePhoto", {
    //   uri: profilePhotoURI,
    //   name: profilePhotoName,
    //   type: profilePhotoType,
    // });
    await axios
      .post(
        `${BASE_URL}api/saveContact`,
        {
          userUUID: userUUID,
          firstName: firstName,
          lastName: lastName,
          mobileNumber: mobileNumber,
          email: email,
          linkNames: linkNames,
          linkURLS: linkURLS,
        },
        {
          headers: { Authorization: `Bearer ${userToken}` },
          "Content-Type": "multipart/form-data",
        }
      )
      .then((response) => {
        console.log(response.data);

        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error.response);
        setIsLoading(false);
      });
  };

  const getInsights = async () => {
    setInsightsLoading(true);
    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .get(
        `${BASE_URL}api/getInsights/${userUUID}`,
        {},
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        console.log(response.data);
        let userProfileTaps = response.data.userProfileTaps;
        let userLinksInsights = response.data.userLinksInsights;
        let totalUserLinkTaps = response.data.totalUserLinkTaps;
        let totalUserConnections = response.data.totalUserConnections;
        let totalProfileViews = response.data.totalProfileViews;

        setUserProfileTaps(userProfileTaps);
        setUserLinksInsights(userLinksInsights);
        setTotalUserLinkTaps(totalUserLinkTaps);
        setTotalUserConnections(totalUserConnections);
        setTotalProfileViews(totalProfileViews);

        console.log(response.data);
        setInsightsLoading(false);
      })
      .catch((error) => {
        console.log(error);
        setInsightsLoading(false);
      });
  };

  const addProfileTap = async (userUUID) => {
    // let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .post(
        `${BASE_URL}api/addProfileTap/${userUUID}`,
        {},
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        console.log(response.data);
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error);
        setIsLoading(false);
      });
  };

  const addProfileView = async (userUUID) => {
    // let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .post(
        `${BASE_URL}api/addProfileView/${userUUID}`,
        {},
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        console.log(response.data);
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error);
        setIsLoading(false);
      });
  };

  const addLinkTap = async (userLinkID) => {
    let userUUID = await SecureStore.getItemAsync("userUUID");
    let userToken = await SecureStore.getItemAsync("userToken");

    await axios
      .post(
        `${BASE_URL}api/addLinkTap/${userLinkID}`,
        {},
        {
          headers: { Authorization: `Bearer ${userToken}` },
        }
      )
      .then((response) => {
        console.log(response.data);
        setIsLoading(false);
      })
      .catch((error) => {
        console.log(error);
        setIsLoading(false);
      });
  };

  const checkToken = async () => {
    let userToken = await SecureStore.getItemAsync("userToken");
    if (userToken) {
      await axios
        .get(`${BASE_URL}api/checkToken`, {
          headers: { Authorization: `Bearer ${userToken}` },
        })
        .then((response) => {
          if (response.data.error) {
            setValidToken(false);
          } else {
            setValidToken(true);
          }
        })
        .catch((error) => {
          console.log(error.response.data);
        });
    } else {
    }
  };

  const isLoggedIn = async () => {
    try {
      setSplashLoading(true);
      setUserInfoLoading(true);

      let userUUID = await SecureStore.getItemAsync("userUUID");
      let userToken = await SecureStore.getItemAsync("userToken");

      let userName = await SecureStore.getItemAsync("userName");
      let userBio = await SecureStore.getItemAsync("userBio");
      let userCoverPhoto = await SecureStore.getItemAsync("userCoverPhoto");
      let userProfilePhoto = await SecureStore.getItemAsync("userProfilePhoto");
      let userActiveYeetDevice = await SecureStore.getItemAsync(
        "userActiveYeetDevice"
      );

      console.log("UserToken: " + userToken);
      console.log("UserUUID: " + userUUID);
      if (!userToken || !userUUID) {
        setSplashLoading(false);
        setUserInfoLoading(false);
        // setIsLoading(false);
        setPublicLoading(false);
        setAddLinkLoading(false);
        setUserLinksLoading(false);
        setNfcDeviceLoading(false);
        setUserConnectionsLoading(false);
        setShowModal(false);
        console.log("No userUUID and userToken");
      }
      // CHECK TOKEN FIRST IF VALID OR NOT
      else if (userUUID && userToken) {
        if (userName) {
          setUserToken(userToken);
          setSplashLoading(false);
          setUserLinksLoading(true);

          setUserName(userName);
          setUserBio(userBio);
          setUserCoverPhoto(userCoverPhoto);
          setUserProfilePhoto(userProfilePhoto);
          setUserActiveYeetDevice(userActiveYeetDevice);
        }
        await axios
          .get(`${BASE_URL}api/getUserData/${userUUID}`, {
            headers: { Authorization: `Bearer ${userToken}` },
          })
          .then((response) => {
            if (response.status === 401) {
              setWelcomeModalVisible(true);
              setModalHeader("Login Error");
              setModalMessage(
                "Oops! It seems your current login has expired. Please sign in again to continue."
              );
              clearAll();
              console.log(response);
            }
            if (response.data.userNotFound) {
              console.log(response.data.userNotFound);
              setWelcomeModalVisible(true);
              setModalHeader("Login Timeout");
              setModalMessage(
                "Oops! It seems your current login has expired. Please sign in again to continue."
              );
              clearAll();
            } else if (response.data.userData) {
              let userInfo = response.data.userData;
              console.log(response.data.userData);

              setUserInfo(userInfo.user);
              setUserActiveYeetDevice(userInfo.activeNFCDevice);
              setUserNFCDevices(userInfo.nfcDevice);
              setUserToken(userInfo.token);
              setUserDirectLink(userInfo.user.usr_direct_link_active);
              setUserDirectLinkID(userInfo.user.uln_id);
              setUserLinks(userInfo.userLinks);
              setUserTheme(userInfo.userTheme);
              setNotificationCount(userInfo.notificationCount);

              console.log("Logged In as: " + userInfo.user.usr_email);
              console.log("NFC Active: " + userInfo.user.nfc_device);
              console.log("Notification Count: " + userInfo.notificationCount);

              setUserName(userInfo.user.usr_name);
              setUserBio(userInfo.user.usr_bio);
              setUserCoverPhoto(userInfo.user.usr_cover_photo_storage);
              setUserProfilePhoto(userInfo.user.usr_profile_photo_storage);

              SecureStore.setItemAsync("userName", userInfo.user.usr_name);
              SecureStore.setItemAsync("userBio", userInfo.user.usr_bio);
              SecureStore.setItemAsync(
                "userCoverPhoto",
                userInfo.user.usr_cover_photo_storage
              );
              SecureStore.setItemAsync(
                "userProfilePhoto",
                userInfo.user.usr_profile_photo_storage
              );
              if (userInfo.activeNFCDevice) {
                SecureStore.setItemAsync(
                  "userActiveYeetDevice",
                  userInfo.activeNFCDevice
                );
              }
            }
            setSplashLoading(false);
            setUserInfoLoading(false);
            setPublicLoading(false);
            setAddLinkLoading(false);
            setUserLinksLoading(false);
            setNfcDeviceLoading(false);
            setUserConnectionsLoading(false);
            setShowModal(false);
          })
          .catch((error) => {
            if (error.response.status === 401) {
              console.log("Data Error: " + error.response.status);

              setWelcomeModalVisible(true);
              setModalHeader("Login Expired");
              setModalMessage(
                "Oops! It seems your current login has expired. Please sign in again to continue."
              );
              clearAll();
            }

            setSplashLoading(false);
            setUserInfoLoading(false);
            setPublicLoading(false);
            setAddLinkLoading(false);
            setUserLinksLoading(false);
            setNfcDeviceLoading(false);
            setUserConnectionsLoading(false);
            setShowModal(false);
          });
      }
    } catch (e) {
      clearAll();
      setSplashLoading(false);

      setUserInfoLoading(false);
      setPublicLoading(false);
      setAddLinkLoading(false);
      setUserLinksLoading(false);
      setNfcDeviceLoading(false);
      setUserConnectionsLoading(false);
      setShowModal(false);

      // clearAll();
      console.log("Error :" + e);
    }
  };

  const clearAll = () => {
    SecureStore.deleteItemAsync("userUUID");
    SecureStore.deleteItemAsync("userToken");
    SecureStore.deleteItemAsync("userName"); 
    SecureStore.deleteItemAsync("userBio");  
    SecureStore.deleteItemAsync("userProfilePhoto");  
    SecureStore.deleteItemAsync("userCoverPhoto"); 
    SecureStore.deleteItemAsync("userActiveYeetDevice");

    setUserInfo({});
    setUserNFCDevices({});
    setUserActiveYeetDevice({});
    setNotificationCount();
    setUserBlockedConnections({});
    setUserToken();
    setUserLinks({});
    setAllLinks({});
    setUserDirectLink();
    setUserDirectLinkID();
    setUserConnections({});
    setUserConnectionData({});
    setUserConnectionLinks({});
    setUserConnectionStatus();
    setUserBlockStatus();
    setUserPrivateStatus();
    setPublicProfileInfo({});
    setPublicProfileLinks({});
    setPublicProfileDirectLink();
    setPublicConnectionStatus();
    setUserNotifications({});
    setUserProfileTaps({});
    setUserLinksInsights({});
    setTotalUserLinkTaps();
    setTotalUserConnections();
    setTotalProfileViews();
    setUserTheme({});
  };

  useEffect(() => {
    isLoggedIn();
  }, []);

  return (
    <AuthContext.Provider
      value={{
        //IMPORTANT STATES
        isLoading,
        setIsLoading,
        splashLoading,
        showModal,
        setShowModal,
        showButtonModal,
        setShowButtonModal,
        showInputModal,
        setShowInputModal,
        setShowSuccessModal,
        showSuccessModal,
        refreshing,
        setRefreshing,
        setModalHeader,
        setModalMessage,
        setErrorMessage,
        checkPassword,
        passwordMatched,
        setPasswordMatched,
        setSplashLoading,
        setUserInfoLoading,
        setModalHeader,
        setModalMessage,
        setPublicProfileLoading,
        publicProfileLoading,

        //FOR EMAIL CHECKING (REGISTRATION STEP 1)
        checkEmailAvailability,

        //FOR CODE CONFIRMATION
        checkConfirmationCode,

        //FOR REGISTER
        valid,
        setValid,
        registered,
        setRegistered,

        register,

        //FOR PASSWORD RESET
        validEmail,
        setValidEmail,
        resetPassword,
        validCode,
        setValidCode,
        validPassword,
        setValidPassword,
        checkPasswordResetCode,
        newPassword,

        //FOR CHECKING IF LOGGED IN
        isLoggedIn,

        //FOR LOGIN
        userInfo,
        setErrorMessage,
        errorMessage,
        setSuccessMessage,
        successMessage,
        login,
        getUserLinks,
        setUserLinks,
        userLinks,
        userToken,
        getUserTheme,
        userTheme,
        setUserTheme,
        notificationCount,
        setNotificationCount,

        //NFC STUFF

        //MODAL MESSAGE
        modalHeader,
        modalMessage,

        //ACTIVATE/REMOVE YEET DEVICE
        nfcDeviceLoading,
        setNfcDeviceLoading,
        getActiveYeetDevice,
        userActiveYeetDevice,
        setUserActiveYeetDevice,
        userNFCDevices,
        setUserNFCDevices,
        activateYeetDevice,
        getYeetDevices,
        displayYeetDevice,
        disconnectYeetDevice,

        //TOGGLE NOTIFICATIONS/ACCOUNT PRIVACY
        toggleNotifications,
        toggleAccountPrivacy,

        //VIEW ALL LINKS
        allLinks,
        getAllLinks,

        //VIEW LINKS THAT USER DOES NOT HAVE
        //SECOND OPTION

        //ADD LINKS
        addLink,
        addCustomLink,
        addYouTubeLink,
        editYouTubeLink,
        addLinkLoading,
        setAddLinkLoading,
        showAddLinkMessage,
        setShowAddLinkMessage,
        uploadPaymentPhoto,

        //EDIT LINKS
        editLink,
        editCustomLink,
        editPaymentPhoto,

        //REMOVE LINKS
        removeLinkFromUser,

        //SET DIRECT LINK
        setDirectLink,
        userDirectLink,
        setUserDirectLink,
        userDirectLinkID,
        setUserDirectLinkID,

        //REMOVE DIRECT LINK
        removeDirectLink,

        // getUserData,
        getUserData,

        //UPDATE USER
        updateProfile,
        updateSuccessModalVisible,
        setUpdateSuccessModalVisible,
        updateErrorModalVisible,
        setUpdateErrorModalVisible,

        updateEmail,
        updatePassword,
        updateMobileNumber,

        //FOR GETTING USER CONNECTIONS
        getUserConnections,
        userConnections,
        setUserConnections,
        searchUserConnections,
        showUserConnection,
        userConnectionStatus,
        setUserConnectionStatus,
        userConnectionData,
        userConnectionLinks,
        userBlockStatus,
        setUserBlockStatus,
        leaveNote,
        reportConnection,
        deleteConnection,
        blockConnection,
        unblockConnection,
        showBlockedConnections,
        userBlockedConnections,
        userPrivateStatus,
        setUserPrivateStatus,
        connectionsScreenModalVisible,
        setConnectionsScreenModalVisible,

        //GET CONNECTION FROM QR
        showProfileFromQR,

        //FOR LOGOUT
        logout,

        //FOR UPLOADING FILE
        uploadFile,
        editFile,

        //FETCHING DATA LOADING STATES
        userInfoLoading,
        userLinksLoading,
        userConnectionsLoading,

        //publicProfile
        showPublicProfile,
        publicProfileInfo,
        publicProfileLinks,
        publicProfileDirectLink,
        publicConnectionStatus,
        addConnection,
        publicLoading,
        userNotFound,
        setUserNotFound,

        //DEACTIVATE/DELETE ACCOUNT
        deactivateAccount,
        deleteAccount,

        //DOWNLOAD AS VCF
        downloadVCF,

        //USER NOTIFICATIONS
        getUserNotifications,
        readNotification,
        openNotification,
        userNotifications,
        setUserNotifications,
        userNotificationsLoading,
        setUserNotificationsLoading,
        removeNotification,
        saveNotificationPushToken,
        getNotificationPushToken,

        //INSIGHTS
        getInsights,
        userProfileTaps,
        setUserProfileTaps,
        userLinksInsights,
        setUserLinksInsights,
        totalUserLinkTaps,
        setTotalUserLinkTaps,
        totalUserConnections,
        setTotalUserConnections,
        addProfileTap,
        addLinkTap,
        addProfileView,
        totalProfileViews,
        setTotalProfileViews,
        insightsLoading,
        setInsightsLoading,
        manageAccountLoading,
        setManageAccountLoading,

        //MODAL SHOW STATES
        loginModalVisible,
        setLoginModalVisible,
        lockedAccountModalVisible,
        setLockedAccountModalVisible,
        forgotEmailModalVisible,
        setForgotEmailModalVisible,
        resetCodeModalVisible,
        setResetCodeModalVisible,
        newPasswordModalVisible,
        setNewPasswordModalVisible,
        registrationModalVisible,
        setRegistrationModalVisible,
        confirmEmailModalVisible,
        setConfirmEmailModalVisible,
        inputNameModalVisible,
        setInputNameModalVisible,
        mobileNumberModalVisible,
        setMobileNumberModalVisible,
        addLinksModalVisible,
        setAddLinksModalVisible,
        viewConnectionModalVisible,
        setViewConnectionModalVisible,
        successPasswordModalVisible,
        setSuccessPasswordModalVisible,
        errorPasswordModalVisible,
        setErrorPasswordModalVisible,
        editLinkMessageModalVisible,
        setEditLinkMessageModalVisible,
        updateAccountModalVisible,
        setUpdateAccountModalVisible,
        updatePasswordErrorModalVisible,
        setUpdatePasswordErrorModalVisible,
        updatePasswordSuccessModalVisible,
        setUpdatePasswordSuccessModalVisible,
        welcomeModalVisible,
        setWelcomeModalVisible,
        deactivateModalVisible,
        setDeactivateModalVisible,
        invalidPasswordModalVisible,
        setInvalidPasswordModalVisible,
        reactivateModalVisible,
        setReactivateModalVisible,
        deleteAccountModalVisible,
        setDeleteAccountModalVisible,
        finalConfirmationModalVisible,
        setFinalConfirmationModalVisible,

        //CACHED DATA
        userName,
        setUserName,
        tempUserName,
        setTempUserName,
        userBio,
        setUserBio,
        tempUserBio,
        setTempUserBio,
        userCoverPhoto,
        setUserCoverPhoto,
        userProfilePhoto,
        setUserProfilePhoto,
        tempCoverPhoto,
        setTempCoverPhoto,
        tempProfilePhoto,
        setTempProfilePhoto,

        //clear all
        clearAll,
      }}
    >
      {children}
    </AuthContext.Provider>
  );
};
